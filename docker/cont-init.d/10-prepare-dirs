#!/command/with-contenv bash
set -euo pipefail

: "${PUID:=911}"
: "${PGID:=911}"
: "${UMASK:=002}"

CONFIG_DIR="/config"
DOWNLOADS_DIR="/downloads"
MUSIC_DIR="/music"
DB_PATH="${CONFIG_DIR}/harmony.db"

mkdir -p "${CONFIG_DIR}" "${DOWNLOADS_DIR}" "${MUSIC_DIR}"
chown -R "${PUID}:${PGID}" "${CONFIG_DIR}"
umask "${UMASK}"

if [ ! -f "${DB_PATH}" ]; then
  s6-setuidgid abc /bin/sh -c "touch '${DB_PATH}'"
fi

for d in "${DOWNLOADS_DIR}" "${MUSIC_DIR}"; do
  if s6-setuidgid abc test -w "${d}"; then
    echo "[ok] ${d} writable"
  else
    echo "[warn] ${d} not writable for ${PUID}:${PGID} â€“ bitte auf dem Host anpassen."
  fi
done
