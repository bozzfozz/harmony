# Konsolidierungs- & Entkopplungs-Matrix

| Komponente | Aktueller Befund | Empfohlene Maßnahme | Art (Merge/Entkoppeln/Entfernen) | Fundstellen | Umsetzungsskizze |
| --- | --- | --- | --- | --- | --- |
| Spotify-Router (`spotify`, `spotify/free`, `backfill`, `free_ingest`) | Mehrfach initialisierte Services/Worker, inkonsistente Validierung & Responses | Gemeinsamen `SpotifyDomainService` + Router-Modul `app/api/spotify.py` erstellen; Worker-Start in Orchestrator verlagern | Zusammenlegen | `app/routers/spotify_router.py`【F:app/routers/spotify_router.py†L16-L233】<br>`app/routers/spotify_free_router.py`【F:app/routers/spotify_free_router.py†L1-L120】<br>`app/routers/backfill_router.py`【F:app/routers/backfill_router.py†L24-L80】 | 1) Service-Klasse extrahieren; 2) Router-Handlers auf Service umstellen; 3) Tests aktualisieren; 4) Alte Router-Module deprecaten und über neuen Sammelrouter exportieren |
| Integrations-/Search-Pipeline | `IntegrationService` behandelt nur Slskd; Such-Router orchestriert Zeitlimits & Scoring allein | `ProviderGateway` bauen, das Adapter über `ProviderRegistry` lädt; Suchrouter ruft Gateway + Ranking-Service | Entkoppeln | `app/services/integration_service.py`【F:app/services/integration_service.py†L31-L86】<br>`app/integrations/registry.py`【F:app/integrations/registry.py†L16-L58】<br>`app/routers/search_router.py`【F:app/routers/search_router.py†L76-L176】 | 1) Interface `TrackProvider` definieren; 2) Gateway implementieren (Timeout/Retry, Mapping); 3) Router & Tests refaktorieren; 4) Alte Spezialfälle entfernen |
| Worker-Lifecycle (`app.main`, einzelne Worker) | Lifecycle-Logik in `app/main.py`, Hardcoded Stop-Liste | Worker-Orchestrator + Registry, Worker melden sich an | Zusammenlegen/Entkoppeln | `app/main.py`【F:app/main.py†L239-L352】<br>`app/workers/watchlist_worker.py`【F:app/workers/watchlist_worker.py†L61-L118】 | 1) `WorkerDescriptor` definieren (Factory + Capabilities); 2) Orchestrator baut Worker & trackt Status; 3) Router/CLI nutzen Orchestrator |
| Persistente Queue (`PersistentJobQueue`) | Visibility Timeout / Idempotenz in jedem Enqueue; kein Shared Retry/DLQ | Gemeinsame Retry-/DLQ-Schicht + Konfigurationsprofil | Entkoppeln | `app/workers/persistence.py`【F:app/workers/persistence.py†L42-L191】 | 1) Retry-Policy-Helper erstellen (Backoff, Visibility); 2) DLQ-Tabelle + Service definieren; 3) Worker auf Helper umstellen |
| Logging-Pattern | Unterschiedliche Event-Formate (`extra` vs. Text) | Logging-Contract anwenden, `log_event` nutzen | Zusammenlegen | `app/services/cache.py`【F:app/services/cache.py†L70-L135】<br>`app/workers/watchlist_worker.py`【F:app/workers/watchlist_worker.py†L93-L103】<br>`app/routers/search_router.py`【F:app/routers/search_router.py†L127-L154】 | 1) Helper + Structured Schema implementieren; 2) Stepwise rollout (Cache → Search → Workers) |
| Frontend API-Wrapper | Hardcodierte Fetch-Aufrufe, pflegt Routen manuell | OpenAPI-basierten Client generieren, Hooks vereinheitlichen | Zusammenlegen | `frontend/src/lib/api.ts`【F:frontend/src/lib/api.ts†L1-L610】 | 1) Schema generieren; 2) Client-Build in CI aufnehmen; 3) Page/Hook-Refactor |
| Config-Landschaft (ENV) | Viele `os.getenv` ohne Profile, Defaults verstreut | Profile + Dokumentation (siehe Config-Matrix) | Entkoppeln | `app/config.py`【F:app/config.py†L120-L299】<br>`app/main.py`【F:app/main.py†L239-L323】 | 1) Profile definieren; 2) Loader anpassen; 3) Docs/Deployment-Skripte updaten |

## Entfernen / Abschalten
- **Legacy-Routen-Logging (`LegacyLoggingRoute`)** – Prüfen, ob `feature.enable_legacy_routes` dauerhaft benötigt wird; falls nicht, Feature-Flag abschalten und Route entfernen.【F:app/main.py†L157-L205】
- **Free Import In-Memory File Store** – Ersatz durch persistente Storage (z. B. S3/DB) evaluieren; aktuell nur in API-State gehalten.【F:app/routers/spotify_free_router.py†L63-L120】

