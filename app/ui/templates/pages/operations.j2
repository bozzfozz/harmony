{% extends "layouts/dashboard.j2" %}
{% import "partials/_strings.j2" as strings %}
{% import "partials/modals.j2" as modals %}

{% block header_actions %}
  <form id="logout-form" method="post" action="/ui/logout">
    <input type="hidden" name="csrftoken" value="{{ csrf_token }}" />
    <button type="submit">{{ strings.button_label("logout") }}</button>
  </form>
{% endblock %}

{% block page_header %}
  <section>
    <h2>{{ strings.section_heading(layout.page_id) }}</h2>
    <p>{{ strings.operations_page_intro() }}</p>
    <p>
      <a href="{{ dashboard_url }}">{{ strings.link_text("operations.back_to_dashboard") }}</a>
    </p>
  </section>
{% endblock %}

{% block dashboard_primary %}
  {% set overview_sections = [] %}
  {% if downloads_fragment %}
    {% set overview_sections = overview_sections + [{
      "fragment": downloads_fragment,
      "section_key": "downloads",
      "description": strings.downloads_page_intro(),
      "data_fragment": "operations-downloads",
    }] %}
  {% endif %}

  {% if jobs_fragment %}
    {% set overview_sections = overview_sections + [{
      "fragment": jobs_fragment,
      "section_key": "jobs",
      "description": strings.jobs_page_intro(),
      "data_fragment": "operations-jobs",
    }] %}
  {% endif %}

  {% set overview_sections = overview_sections + [
    {
      "fragment": watchlist_fragment,
      "section_key": "watchlist",
      "description": strings.watchlist_page_intro(),
      "data_fragment": "operations-watchlist",
    },
    {
      "fragment": activity_fragment,
      "section_key": "activity",
      "description": strings.activity_page_intro(),
      "data_fragment": "operations-activity",
    },
  ] %}

  {% for section in overview_sections %}
    {% set fragment = section["fragment"] %}
    <section class="page-section page-section--card" aria-labelledby="{{ fragment.identifier }}-heading">
      <header class="page-section__header">
        <h3 id="{{ fragment.identifier }}-heading" class="page-section__title">
          {{ strings.section_heading(section["section_key"]) }}
        </h3>
      </header>
      {% if section["description"] %}
        <p class="page-section__description">{{ section["description"] }}</p>
      {% endif %}
      <div id="{{ fragment.identifier }}"
           class="async-fragment"
           role="region"
           aria-live="polite"
           aria-labelledby="{{ fragment.identifier }}-heading"
           data-fragment="{{ section["data_fragment"] }}"
           {% if fragment.event_name %}data-live-event="{{ fragment.event_name }}"{% endif %}
          hx-get="{{ fragment.url }}"
          hx-trigger="{{ fragment.trigger }}"
          hx-target="{{ fragment.target }}"
          hx-swap="{{ fragment.swap }}"
          hx-on="htmx:responseError:handleHtmxError(event)">
        <p class="async-fragment__placeholder">
          {{ strings.fragment_loading(fragment.loading_key) }}
        </p>
      </div>
    </section>
  {% endfor %}
{% endblock %}

{% block dashboard_secondary %}
  {% set operations_links = [] %}
  {% if downloads_fragment %}
    {% set operations_links = operations_links + [{
      "identifier": "operations-downloads-link",
      "href": downloads_page_url,
      "label": strings.link_text("operations.view_downloads"),
    }] %}
  {% endif %}
  {% if jobs_fragment %}
    {% set operations_links = operations_links + [{
      "identifier": "operations-jobs-link",
      "href": jobs_page_url,
      "label": strings.link_text("operations.view_jobs"),
    }] %}
  {% endif %}
  {% set operations_links = operations_links + [
    {
      "identifier": "operations-watchlist-link",
      "href": watchlist_page_url,
      "label": strings.link_text("operations.view_watchlist"),
    },
    {
      "identifier": "operations-activity-link",
      "href": activity_page_url,
      "label": strings.link_text("operations.view_activity"),
    },
  ] %}

  <div class="sidebar-sections">
    <section class="sidebar-section" aria-labelledby="operations-navigation-title">
      <h3 id="operations-navigation-title" class="sidebar-section__title">
        {{ strings.section_heading("operations") }}
      </h3>
      <ul class="sidebar-section__list">
        {% for link in operations_links %}
          <li class="sidebar-section__list-item">
            <a href="{{ link["href"] }}" data-test="{{ link["identifier"] }}">
              {{ link["label"] }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </section>
  </div>
{% endblock %}

{% block modals %}
  {{ modals.render_modals(layout.modals) }}
  <div id="modal-root" data-role="modal-container"></div>
  {% block dashboard_modals %}{% endblock %}
{% endblock %}
