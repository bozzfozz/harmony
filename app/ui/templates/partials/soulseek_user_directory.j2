{% import "partials/_strings.j2" as strings %}
{% import "partials/status_badges.j2" as status_badges %}

<form class="form soulseek-user-form"
      method="get"
      action="{{ browse_url }}"
      hx-get="{{ browse_url }}"
      hx-target="#hx-soulseek-user-directory"
      hx-swap="outerHTML"
      data-test="soulseek-user-directory-form">
  <div class="form-field">
    <label for="soulseek-user-directory-username">{{ strings.form_label("soulseek.user.username") }}</label>
    <input type="text"
           id="soulseek-user-directory-username"
           name="username"
           value="{{ username }}"
           required
           autocomplete="off" />
  </div>
  <div class="form-field">
    <label for="soulseek-user-directory-path">{{ strings.form_label("soulseek.user.path") }}</label>
    <input type="text"
           id="soulseek-user-directory-path"
           name="path"
           value="{{ path if path else "" }}"
           autocomplete="off" />
  </div>
  <button type="submit">{{ strings.button_label("soulseek.user.browse") }}</button>
</form>

{% set show_status = has_user_status or has_user_browse_status %}

{% if show_status %}
  <section class="soulseek-user-section" data-test="soulseek-user-status">
    <h4>{{ strings.soulseek_user_status_heading() }}</h4>
    {% if has_user_status %}
      <div class="soulseek-user-status-summary">
        {% if user_status_badge %}
          {{ status_badges.render_badge(user_status_badge) }}
        {% endif %}
        {% if user_status_has_shared %}
          <p data-test="soulseek-user-status-shared">{{ strings.soulseek_user_status_shared(user_status_shared) }}</p>
        {% endif %}
        {% if user_status_message %}
          <p data-test="soulseek-user-status-message">{{ user_status_message }}</p>
        {% elif not user_status_badge and not user_status_has_shared %}
          <p data-test="soulseek-user-status-empty">{{ strings.soulseek_user_status_empty(username) }}</p>
        {% endif %}
      </div>
    {% endif %}
    {% if has_user_browse_status %}
      <div class="soulseek-user-browse" data-test="soulseek-user-browse-status">
        <h5>{{ strings.soulseek_user_browse_heading() }}</h5>
        {% if user_browse_badge %}
          {{ status_badges.render_badge(user_browse_badge) }}
        {% endif %}
        {% if user_browse_has_progress %}
          <p data-test="soulseek-user-browse-progress">{{ strings.soulseek_user_browse_progress(user_browse_progress) }}</p>
        {% endif %}
        {% if user_browse_has_queue %}
          {% set queue_position = user_browse_queue[0] %}
          {% set queue_total = user_browse_queue[1] %}
          <p data-test="soulseek-user-browse-queue">{{ strings.soulseek_user_browse_queue(queue_position, queue_total) }}</p>
        {% endif %}
        {% if user_browse_message %}
          <p data-test="soulseek-user-browse-message">{{ user_browse_message }}</p>
        {% elif (not user_browse_badge and not user_browse_has_progress and not user_browse_has_queue) %}
          <p data-test="soulseek-user-browse-empty">{{ strings.soulseek_user_browse_empty() }}</p>
        {% endif %}
      </div>
    {% endif %}
  </section>
{% endif %}

{% if has_listing %}
  <div class="soulseek-directory-context" data-test="soulseek-user-directory-context">
    {% if path %}
      <p class="soulseek-directory-path">{{ strings.soulseek_user_directory_path(path) }}</p>
    {% endif %}
    {% if parent_url %}
      <button type="button"
              class="soulseek-directory-parent"
              hx-get="{{ parent_url }}"
              hx-target="#hx-soulseek-user-directory"
              hx-swap="outerHTML"
              data-test="soulseek-user-directory-parent">{{ strings.soulseek_user_directory_parent() }}</button>
    {% endif %}
  </div>
  <div class="soulseek-directory-list" data-test="soulseek-user-directories">
    <h4>{{ strings.soulseek_user_directories_heading() }}</h4>
    {% if directories %}
      <ul class="soulseek-directory-items">
        {% for entry in directories %}
          <li>
            <button type="button"
                    hx-get="{{ entry.url }}"
                    hx-target="#hx-soulseek-user-directory"
                    hx-swap="outerHTML"
                    data-test="soulseek-user-directory-entry">{{ entry.name }}</button>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p data-test="soulseek-user-directories-empty">{{ strings.soulseek_user_directories_empty() }}</p>
    {% endif %}
  </div>
  <div class="soulseek-directory-files" data-test="soulseek-user-files">
    <h4>{{ strings.soulseek_user_files_heading() }}</h4>
    {% if files %}
      <table>
        <thead>
          <tr>
            <th scope="col">{{ strings.soulseek_user_files_name() }}</th>
            <th scope="col">{{ strings.soulseek_user_files_size() }}</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
            <tr>
              <td>{{ file.name }}</td>
              <td>{{ file.size if file.size else strings.soulseek_user_files_unknown_size() }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p data-test="soulseek-user-files-empty">{{ strings.soulseek_user_files_empty() }}</p>
    {% endif %}
  </div>
{% elif username %}
  <p class="soulseek-directory-empty" data-test="soulseek-user-directory-empty">{{ strings.soulseek_user_directory_empty(username) }}</p>
{% else %}
  <p class="soulseek-directory-help" data-test="soulseek-user-directory-help">{{ strings.soulseek_user_directory_help() }}</p>
{% endif %}
