{% import "partials/_strings.j2" as strings %}
{% import "partials/status_badges.j2" as badges %}

{% macro render_table(table) -%}
  <table id="{{ table.identifier }}" class="table">
    {% if table.caption_key %}
      <caption>{{ strings.caption(table.caption_key) }}</caption>
    {% endif %}
    <thead>
      <tr>
        {% for header_key in table.column_keys %}
          <th scope="col">{{ strings.table_header(header_key) }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in table.rows %}
        <tr {% if row.test_id %}data-test="{{ row.test_id }}"{% endif %}>
          {% for cell in row.cells %}
            <td {% if cell.test_id %}data-test="{{ cell.test_id }}"{% endif %}>
          {% if cell.badge %}
            {{ badges.render_badge(cell.badge) }}
          {% elif cell.text_key %}
            {{ strings.table_cell(cell.text_key) }}
          {% elif cell.text %}
            {{ cell.text }}
          {% elif cell.form %}
            {% set form = cell.form %}
            <form method="{{ form.method }}"
                  action="{{ form.action }}"
                  {% if form.hx_method == "get" %}
                    hx-get="{{ form.action }}"
                  {% elif form.hx_method == "put" %}
                    hx-put="{{ form.action }}"
                  {% elif form.hx_method == "patch" %}
                    hx-patch="{{ form.action }}"
                  {% elif form.hx_method == "delete" %}
                    hx-delete="{{ form.action }}"
                  {% else %}
                    hx-post="{{ form.action }}"
                  {% endif %}
                  {% if form.hx_target %}hx-target="{{ form.hx_target }}"{% endif %}
                  hx-swap="{{ form.hx_swap }}"
                  {% if form.hx_headers_json %}hx-headers='{{ form.hx_headers_json }}'{% endif %}>
              {% for name, value in form.hidden_fields.items() %}
                <input type="hidden" name="{{ name }}" value="{{ value }}" />
              {% endfor %}
              {% for field in form.fields %}
                {% set placeholder = field.placeholder %}
                {% if not placeholder and field.label_key %}
                  {% set placeholder = strings.form_help(field.label_key) %}
                {% endif %}
                {% if field.input_type == "textarea" %}
                  <textarea name="{{ field.name }}"
                            {% if field.label_key %}aria-label="{{ strings.form_label(field.label_key) }}"{% endif %}
                            {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
                            {% if form.disabled %}disabled{% endif %}
                            {% if field.required %}required{% endif %}>{{ field.value or "" }}</textarea>
                {% else %}
                  <input type="{{ field.input_type }}"
                         name="{{ field.name }}"
                         {% if field.label_key %}aria-label="{{ strings.form_label(field.label_key) }}"{% endif %}
                         {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
                         {% if field.value %}value="{{ field.value }}"{% endif %}
                         {% for attr_name, attr_value in field.attributes.items() %}{{ attr_name }}="{{ attr_value }}" {% endfor %}
                         {% if form.disabled %}disabled{% endif %}
                         {% if field.required %}required{% endif %} />
                {% endif %}
              {% endfor %}
              <button type="submit" {% if form.disabled %}disabled{% endif %}>
                {{ strings.button_label(form.submit_label_key) }}
              </button>
            </form>
          {% endif %}
        </td>
      {% endfor %}
    </tr>
      {% endfor %}
    </tbody>
  </table>
{%- endmacro %}

{% macro render_table_fragment(fragment) -%}
  <div id="{{ fragment.identifier }}"
       class="table-fragment"
       {%- for key, value in fragment.data_attributes.items() %}
         data-{{ key }}="{{ value }}"
       {%- endfor %}>
    {% if fragment.table.rows %}
      {{ render_table(fragment.table) }}
    {% else %}
      <p class="empty-state">{{ strings.empty_state(fragment.empty_state_key) }}</p>
    {% endif %}
    {% if fragment.pagination and (fragment.pagination.previous_url or fragment.pagination.next_url) %}
      {% set pagination = fragment.pagination %}
      <nav class="pagination"
           aria-label="{{ strings.pagination_label(pagination.label_key) }}">
        {% if pagination.previous_url %}
          <button type="button"
                  hx-get="{{ pagination.previous_url }}"
                  hx-push-url="{{ pagination.previous_url }}"
                  hx-target="{{ pagination.target }}"
                  hx-swap="{{ pagination.swap }}">
            {{ strings.pagination_prev() }}
          </button>
        {% endif %}
        {% if pagination.next_url %}
          <button type="button"
                  hx-get="{{ pagination.next_url }}"
                  hx-push-url="{{ pagination.next_url }}"
                  hx-target="{{ pagination.target }}"
                  hx-swap="{{ pagination.swap }}">
            {{ strings.pagination_next() }}
          </button>
        {% endif %}
      </nav>
    {% endif %}
  </div>
{%- endmacro %}
