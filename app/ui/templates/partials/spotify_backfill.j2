{% import "partials/_strings.j2" as strings %}
{% import "partials/alerts.j2" as alerts %}

{{ alerts.render_alerts(alert_messages) }}

<div class="spotify-backfill">
  <p class="spotify-backfill__hint">{{ strings.spotify_backfill_hint() }}</p>
  <form id="spotify-backfill-form"
        method="post"
        action="/ui/spotify/backfill/run"
        hx-post="/ui/spotify/backfill/run"
        hx-target="closest .async-fragment"
        hx-swap="innerHTML">
    <input type="hidden" name="csrftoken" value="{{ snapshot.csrf_token }}" />
    <label for="max_items">{{ strings.form_label("spotify.backfill.max_items") }}</label>
    <input type="number" id="max_items" name="max_items" min="1" {% if snapshot.default_max_items %}value="{{ snapshot.default_max_items }}"{% endif %} />
    <details class="spotify-backfill__advanced">
      <summary>{{ strings.spotify_backfill_advanced_summary() }}</summary>
      {% for option in snapshot.options %}
        <div class="spotify-backfill__option">
          <label for="spotify-backfill-option-{{ option.name }}">
            {% if option.name == "include_cached_results" %}
              <input type="hidden" name="{{ option.name }}" value="0" />
            {% endif %}
            <input type="checkbox"
                   id="spotify-backfill-option-{{ option.name }}"
                   name="{{ option.name }}"
                   value="1"
                   {% if option.checked %}checked{% endif %}
                   {% if not option.enabled %}disabled{% endif %} />
            {{ strings.spotify_backfill_option_label(option.label_key) }}
          </label>
          {% if option.description_key %}
            <p class="spotify-backfill__option-hint">{{ strings.spotify_backfill_option_hint(option.description_key) }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </details>
    <button type="submit" {% if not snapshot.can_run %}disabled{% endif %}>{{ strings.button_label("spotify.backfill.run") }}</button>
  </form>
  {% if snapshot.last_job_id %}
    <section class="spotify-backfill__status">
      <h4>{{ strings.spotify_backfill_latest_heading() }}</h4>
      <dl>
        <dt>{{ strings.spotify_backfill_field_label("id") }}</dt>
        <dd>{{ snapshot.last_job_id }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("state") }}</dt>
        <dd>{{ snapshot.state or strings.spotify_backfill_unknown_state() }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("requested") }}</dt>
        <dd>{{ snapshot.requested or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("processed") }}</dt>
        <dd>{{ snapshot.processed or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("matched") }}</dt>
        <dd>{{ snapshot.matched or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("cache_hits") }}</dt>
        <dd>{{ snapshot.cache_hits or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("cache_misses") }}</dt>
        <dd>{{ snapshot.cache_misses or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("expanded_playlists") }}</dt>
        <dd>{{ snapshot.expanded_playlists or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("expanded_tracks") }}</dt>
        <dd>{{ snapshot.expanded_tracks or 0 }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("include_cached_results") }}</dt>
        <dd>{{ "Yes" if snapshot.include_cached_results else "No" }}</dd>
        <dt>{{ strings.spotify_backfill_field_label("duration") }}</dt>
        <dd>{{ strings.spotify_backfill_duration(snapshot.duration_ms) }}</dd>
      </dl>
      <div class="spotify-backfill__actions">
        <form method="post"
              action="/ui/spotify/backfill/pause"
              hx-post="/ui/spotify/backfill/pause"
              hx-target="closest .async-fragment"
              hx-swap="innerHTML">
          <input type="hidden" name="csrftoken" value="{{ snapshot.csrf_token }}" />
          <input type="hidden" name="job_id" value="{{ snapshot.last_job_id }}" />
          <button type="submit" {% if not snapshot.can_pause %}disabled{% endif %}>{{ strings.button_label("spotify.backfill.pause") }}</button>
        </form>
        <form method="post"
              action="/ui/spotify/backfill/resume"
              hx-post="/ui/spotify/backfill/resume"
              hx-target="closest .async-fragment"
              hx-swap="innerHTML">
          <input type="hidden" name="csrftoken" value="{{ snapshot.csrf_token }}" />
          <input type="hidden" name="job_id" value="{{ snapshot.last_job_id }}" />
          <button type="submit" {% if not snapshot.can_resume %}disabled{% endif %}>{{ strings.button_label("spotify.backfill.resume") }}</button>
        </form>
        <form method="post"
              action="/ui/spotify/backfill/cancel"
              hx-post="/ui/spotify/backfill/cancel"
              hx-target="closest .async-fragment"
              hx-swap="innerHTML">
          <input type="hidden" name="csrftoken" value="{{ snapshot.csrf_token }}" />
          <input type="hidden" name="job_id" value="{{ snapshot.last_job_id }}" />
          <button type="submit" {% if not snapshot.can_cancel %}disabled{% endif %}>{{ strings.button_label("spotify.backfill.cancel") }}</button>
        </form>
      </div>
      {% if snapshot.error %}
        <p class="spotify-backfill__error">{{ snapshot.error }}</p>
      {% endif %}
    </section>
  {% else %}
    <p class="spotify-backfill__empty">{{ strings.spotify_backfill_empty_state() }}</p>
  {% endif %}
  {% if timeline %}
    <section class="spotify-backfill__timeline" data-test="spotify-backfill-timeline">
      <h4>{{ strings.spotify_backfill_timeline_heading() }}</h4>
      <ol class="spotify-backfill__timeline-list">
        {% for entry in timeline %}
          <li class="spotify-backfill__timeline-item" data-test="spotify-backfill-timeline-entry">
            <div class="spotify-backfill__timeline-meta">
              <span class="spotify-backfill__timeline-created">
                {{ strings.spotify_backfill_timeline_created_label() }}: {{ entry.created_display or "â€”" }}
              </span>
              {% if entry.updated_display %}
                <span class="spotify-backfill__timeline-updated">
                  {{ strings.spotify_backfill_timeline_updated_label() }}: {{ entry.updated_display }}
                </span>
              {% endif %}
            </div>
            <dl class="spotify-backfill__timeline-details">
              <dt>{{ strings.spotify_backfill_field_label("id") }}</dt>
              <dd>{{ entry.identifier }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("state") }}</dt>
              <dd>{{ entry.state }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("processed") }}</dt>
              <dd>{{ entry.processed }} / {{ entry.requested }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("matched") }}</dt>
              <dd>{{ entry.matched }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("cache_hits") }}</dt>
              <dd>{{ entry.cache_hits }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("cache_misses") }}</dt>
              <dd>{{ entry.cache_misses }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("expanded_playlists") }}</dt>
              <dd>{{ entry.expanded_playlists }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("expanded_tracks") }}</dt>
              <dd>{{ entry.expanded_tracks }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("include_cached_results") }}</dt>
              <dd>{{ "Yes" if entry.include_cached_results else "No" }}</dd>
              <dt>{{ strings.spotify_backfill_expand_label() }}</dt>
              <dd>{{ "Yes" if entry.expand_playlists else "No" }}</dd>
              <dt>{{ strings.spotify_backfill_field_label("duration") }}</dt>
              <dd>{{ strings.spotify_backfill_duration(entry.duration_ms) }}</dd>
            </dl>
            {% if entry.error %}
              <p class="spotify-backfill__timeline-error">{{ entry.error }}</p>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </section>
  {% endif %}
</div>
