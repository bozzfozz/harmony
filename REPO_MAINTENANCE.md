# Repository Maintenance Guide

## Continuous Integration

### Workflow Overview
- **`CI`** (`.github/workflows/ci.yml`)
  - Runs on every push and pull request.
  - Provides two jobs:
    - `ci-backend`: Python 3.11 toolchain (mypy, ruff format --check, ruff lint, pytest + coverage gate, pip-audit).
    - `ci-frontend`: Node.js 20 pipeline (eslint, build, unit tests). Automatically skips when no `frontend/package.json` is present.
  - Concurrency key `${{ github.workflow }}-${{ github.ref }}` cancels superseded runs per branch.
  - Artifacts: `reports/coverage.xml`, `reports/junit.xml`.

- **`Nightly`** (`.github/workflows/nightly.yml`)
  - Scheduled for 01:00 Europe/Berlin (handled by dual UTC triggers and runtime guard).
  - Generates dependency and security reports (pip-audit, npm audit, gitleaks) plus CycloneDX SBOMs.
  - Artifacts retained for 7 days under the `nightly-security-reports` bundle.

- **`Release`** (`.github/workflows/release.yml`)
  - Triggered by tags matching `v*.*.*` or manual dispatch.
  - Builds Python source/wheel packages and, when present, a compressed frontend bundle.
  - Publishes GitHub release assets with autogenerated notes.

### Required Checks
Configure branch protection so pull requests require:
- **`ci-backend`** — ensures linting, formatting, typing, security, and test coverage succeed (`RUN_POSTGRES_TESTS=0`, `-m "not postgres"`).
- **`ci-frontend`** — enable only when the frontend job runs (repository contains `frontend/package.json`).

> **Action:** After merging the CI reset (TASK `CODX-CI-RESET-001`), set these jobs as required checks in repository settings (`Settings → Branches → Branch protection rules`). Document decisions in the rule description.

### pre-commit.ci
- pre-commit.ci ist für dieses Repository aktiviert und erstellt bei Bedarf Auto-Fix-Commits mit der Nachricht `chore: pre-commit.ci auto fixes`.
- Der Dienst führt denselben Hook wie lokal (`ruff-format` + `ruff`) aus und pusht ausschließlich, wenn Dateien geändert wurden.
- CI bleibt merge-blockierend: `ci-backend` führt `ruff format --check .` sowie `ruff check --output-format=github .` read-only aus, falls nach den Auto-Fixes noch Drift besteht.

### Postgres Marker Policy
- CI defaults to `RUN_POSTGRES_TESTS="0"` with `pytest -m "not postgres"`.
- To run database-dependent tests locally, export `RUN_POSTGRES_TESTS=1` and invoke `pytest` without the marker filter.
- New Postgres-specific tests **must** use the `@pytest.mark.postgres` decorator to remain skipped in shared CI.
- Reviewers verify new tests respect the marker policy before merge.

### Local Opt-in Examples
```bash
# Run full test suite including Postgres cases
export RUN_POSTGRES_TESTS=1
pytest

# Run backend pipeline locally
ruff format --check .
ruff check --output-format=github .
mypy app
pytest -m "not postgres" --cov=app --cov-fail-under=85
pip-audit -r requirements.txt
```

## Nightly Report Retrieval
Download the `nightly-security-reports` artifact from the latest scheduled run to review:
- `pip-audit.json`
- `npm-audit.json` (when frontend present)
- `gitleaks-report.json`
- `backend-sbom.xml` and `frontend-sbom.json`

Investigate critical/high findings within 24 hours. Track follow-ups in `ToDo.md` referencing the relevant artifact and run ID.

## Release Checklist
1. Bump version metadata and changelog.
2. Tag release (`git tag vX.Y.Z && git push origin vX.Y.Z`).
3. Confirm the `Release` workflow uploads:
   - `dist/*.tar.gz` and `dist/*.whl` assets.
   - Optional `frontend-dist.tar.gz` when the frontend build succeeds.
4. Update release notes with highlights, breaking changes, and rollback guidance.

## Operational Ownership
- **Primary Owner:** Team Platform Engineering.
- **Escalation:** Post findings in `#harmony-ci` within 1 business day.
- **Monitoring:** Review the first five post-reset PRs to ensure runtimes stay under the 8-minute target with warm caches.
